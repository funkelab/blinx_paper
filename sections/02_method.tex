\section{Method}

\subsection{Model}
Consider multiple fluorescent emitters, smaller than can be visually separated.
%
Each emitter blinks stochastically and independently of the others, 
yielding a fluctuating intensity signal over time (see \figref{fig:method:overview} A).
%
The goal of this method is to determine the posterior distribution over possible number of emitters \ndist given the observed intensity trace \trace.
%
Beacuase \ndist is discrete, individual models must be independantly fit for each possible value of $n$, and the posterior distribution can be written as:
% 
\begin{equation*}
  p(n | \trace) \propto p(n) p(\trace | n)
\end{equation*}
%
Assuming a uniform prior on the number of emitters:
\begin{equation*}
  p(n | \trace) \propto p(\trace | n)
\end{equation*}
%
where $p(\trace|n)$ is the model evidence also known as the marginal likelihood:
\begin{equation*}
  p(x | n) = \int p(\trace | \theta, n) p(\theta | n) d\theta
\end{equation*}

This integral over all possible parameters can be approximated using the Laplace approximation also called an Occam factor (derrivation in SI)
\begin{equation}
  \ln p(\trace | n) \approx \ln p(\trace | \theta_{MAP}) + \ln p(\theta_{MAP}) + \frac{M}{2} \ln(2\pi) - \frac{1}{2} \ln |A|
  \label{eq:method:evidence_with_m}
\end{equation}
\begin{equation*}
  A = -\nabla \nabla \ln p(\theta_{MAP} | \trace)
\end{equation*}

%
Where $|A|$ is the determinant of the Hessian matrix of second derrivatives of the negative log posterior, and $M$ is the dimentionality of $\theta$. 
%
In the case of our models, the dimentionality of $\theta$ is constant for all possible $n$ (only the size of the transition matrix changes),
therefore this term becomes a constant and can be dropped from \eqref{eq:method:evidence_with_m}, resulting in:
\begin{equation}
  \ln p(\trace | n) \approx \ln p(\trace | \theta_{MAP}, n) + \ln p(\theta_{MAP}) - \frac{1}{2} \ln |A|
  \label{eq:method:evidence}
\end{equation}

Therefore, to estimate the posterior distribution over $n$ we first need to find the maximum a posteriori parameters for each value of $n$,
and to define any priors on $\theta$.

\subsection{Optimization of individual models}

Because \trace is a series of squential intensity measurements, we choose to model this distribution as a Hidden Markov Model with hidden state $z$

\begin{equation}
  p(\trace| n) = \prod_{t=0}^{T} p(x_{t} | z_{t}, \theta) p(z_{t} | z_{t-1}, \theta n)
  \label{eq:method:base}
\end{equation}

Where $z_{t}$ represents the number of emitters "active" and producing flourescent signal at time $t$.

\subsubsection{Intensity Model}
%
\begin{equation*}
  p(n | \trace) \propto p(\trace| n)
\end{equation*}
%
Expanding this expression to include all observations $t$ from time $t=0,...,T$
%
\begin{equation*}
  p(\trace| n) = \prod_{t=0}^{T} p(x_{t} | n)
\end{equation*}
%
Accounting for the intensity fluctuations due to blinking, we define $z_{t}$ as the number of emitters that are active and emitting photons at time $t$.
%
\begin{equation}
  p(\trace| n) = \prod_{t=0}^{T} p(x_{t} | z_{t}) p(z_{t} | n)
  \label{eq:method:base}
\end{equation}
%
Next, we must derrive expression for the intensity distribution $p(x | z)$ and for the transition distribution $p(z | n)$

\subsubsection{Intensity Model}

For a single frame $t$, with an exposure time of $\Delta t$, the number of photons detected is altered by shot noise and can be decribed by the poisson distribution:
%
\begin{equation*}
  p(c) = \text{Poisson}(\lambda_{t})
\end{equation*}
\begin{equation*}
  \lambda_{t} = r_{E} \Delta t
\end{equation*}


where $c$ is the photon count, $\Lambda$ is the mean number of photons detected and $r_{E}$ is the photon emission rate of an active emitter.
%
Assuming that all emitters are independant, $\Lambda$ can be re-written to account for $z$ emitters and a background photon emission rate 
$r_{BG}$ (In DNA-PAINT experiments this background emission is produced by un-bound imager strands in solution):
%
\begin{equation*}
	\lambda_{t} = (z_{t} r_{E} + r_{BG})\Delta t
\end{equation*}

When using a SCMOS camera, the readout noise must be accounted for in addition to the shot noise. 
This combined noise can be expressed as the convolution of a poisson (shot) and normal (readout) distribution,
which following a derrivation from (Video rate nanoscopy) can be approximated as a shifted poisson distribution.
Finally, at large means, the poisson distribution approaches the normal distribution giving rise to our intesnity distribution:

\begin{equation}
  p(\tilde{x}_{t}| z_{t}, \theta) = \text{Normal} \left(\lambda_{t}, \lambda_{t} + \frac{\sigma}{g^{2}} \right)
  \label{eq:method:intensity_distribution}
\end{equation}

\begin{equation*}
  \tilde{x}_{t} = \frac{(x_{t} - \mu)}{g} + \frac{\sigma}{g^{2}}
\end{equation*}


Where $x$ is the observed intensity readout in ADU, $\theta = (\mu, \sigma, g, r_{E}, r_{BG})$, and $\mu$, $\sigma$,
and $g$ are the mean camera offset, variance, and gain respectively.
%
A full derrivation of \eqref{eq:method:intensity_distribution} can be found in the SI.


\subsubsection{Transition Model}
Next, to model the step-like temporal fluctuations in intensity, observed in the trace \trace, 
a distribution is needed that describes the change in the number of active emitters \states over time. 
%
To do this, we assume that the process is Markovian and the number of active emitters \z{t} 
at time $t$ is only dependent on the number of active emitters at the previous timepoint \z{t-1}.
%
On the individual emitter level, we define \poff as the probability of an emitter active at $t-1$ becoming 
inactive at $t$. Conversely, we define \pon as the probability of an emitter inactive at $t-1$ becoming active at time $t$
%
Finally, assuming that all emitters share the same \poff and \pon, the transition distribution can be written as:
% 
\begin{align}
  \label{eq:method:transition}
  p(z_{t} = z | z_{t-1}, n, \pon, \poff) &=\\
	\sum_{a = 0}^{z_{t-1}}
    {a \choose z_{t-1}}
    &\poff
    {z - z_{t-1} + a \choose \n - z_{t-1}}
    \pon
    \text{,} \notag\
\end{align}
%
Note that this distribution depends on the total number of available emitters
$n$, as the probability of a change in the number of activate emitters
depends on the total number of emitters available.


\subsubsection{Combined Model}



Substituting the intensity distribution \eqref{eq:method:intensity_distribution} and transition distribution \eqref{eq:method:transition} 
into \eqref{eq:method:base} and marginalizing over all possible \states
% 
\begin{align}
  \label{eq:method:likelihood}
  p(\trace|\n,\parameters) &=\\
    \sum_{\states}
      p(&\tilde{x}_{1}|z_{1}, \parameters)
      p(z_{1}|\n, \parameters)
      \prod_{t=2}^{T}
        p(\tilde{x}_{t}|z_{t}, \parameters)
        p(z_{t}|z_{t-1},\n, \parameters)
    \notag
  \text{.}
\end{align}
%
Where $\theta = (\pon, \poff, r_{E}, r_{BG}, \mu, \sigma, g)$

All parameters within \parameters can then be fit through maximum likelihood optimization to best fit the observation \trace, given \n. 
%
Repeating this process for all possible values of \n, allows us to build the postirior distribution $p(n | \trace)$ and to estimate the most likely count \estimatedn.
%
\begin{equation}
    \estimatedn =
    \text{arg}\max_{n}(
    \max_\parameters
    p(\trace|\n,\parameters))
  \text{.}
  \label{eq:method:optimization}
\end{equation}

\subsubsection{Inference}



\subsection{Experimental}
\subsubsection{DNA-Origami}


\subsubsection{Microscopy}



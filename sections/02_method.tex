\section{Method}

Starting from the photo-physics of the system, we derive a probabilistic model,
accounting for both the observed intensity, and the temporal fluctuation
kinetics.
  %
  Given an intensity trace, the output of our method \ours is the posterior
  distribution over molecular counts, providing not only the most likely count,
  but also a comparison to all other possible counts. 

\subsection{Model}

We consider the case of multiple fluorescent emitters within a single
diffraction limited spot.
%
  As such, we can only measure their combined intensity contributions
  $\x{t}$ at a timepoint $t$.
  %
  We assume that each emitter blinks stochastically and independently of the
  others, yielding a fluctuating trace $\trace = (\x{1},\ldots,\x{T})$ of total
  intensity measurements over $T$ frames (see an example in
  \figref{fig:method:overview}a).
  %
  Our goal now is to infer the number of emitters \n, given \trace.

More formally, we are interested in modelling a posterior distribution of the
number of emitters given the intensity trace, \ie:
  %
  \begin{equation*}
    p(\n | \trace) \propto p(n) p(\trace | \n)
  \end{equation*}
  %
  % Can ignore p(n)
  Assuming a uniform prior on the number of emitters, $p(\n)$ can be ignored
  and it remains to model the likelihood $p(\trace|\n)$.
  %
  % choose to model as HMM
  %
  We model this likelihood as a \hmm where the hidden state, denoted by \z{t},
  represents the number of emitters that are active and emitting photons at
  time $t$ (see \figref{fig:method:overview}d).
  %
  The whole \hmm is conditioned on several parameters \parameters, (
    \parametersc: camera parameters, \parameterse: emission parameters, 
    and \parameterst: transition parameters).
  %
  \begin{equation}
    p(\trace| \n, \parameters) =
      \prod_{t=1}^{T}
        p(\x{t} | \z{t}, \parameters)
        p(\z{t} | \z{t-1}, \parameters, \n)
    \text{,}
    \label{eq:method:HMM}
  \end{equation}
  %
  where we define $p(\z{1}|\z{0},\parameters,\n)=p(\z{}|\parameters,\n)$, \ie,
  the initial distribution of the hidden state $\z{}$ is the stationary
  distribution.

  Following this framework, the likelihood is the product of two probability
  distributions: an intensity model $p(\x{t}|\z{t},\parameters)$ and a
  transition model $p(\z{t}|\z{t-1},\parameters,\n)$.

\subsubsection{Intensity Model}

The distribution of observed intensity measurements \x{t} given the number of
currently active emitters \z{t} can be directly derived from the photo-physics
of our microscope system.
  %
  (Note that in the following section we omit the subscript $t$ for clarity.)
  %
  Working backwards through the light path, the measured intensity value \x{}
  is a function of the number of photons \photons detected
  (\figref{fig:method:overview}c).
  %
  The detector itself contributes noise to the system, known as the readout
  noise, which we model as $p(\x{}|\photons,\parametersc)$.
  %
  The number of photons hitting the detector, in turn, depend on the number of
  active emitters \z{} and are distributed following a shot noise model
  $p(\photons|\z{},\parameterse)$.

The probability of observing an intensity \x{} given \z{} can then be obtained
by marginalizing over \photons, \ie:
  %
  \begin{equation}
    p(\x{}|\z{},\parameters) =
      \sum_\photons
        \underbrace{p(\x{}|\photons,\parametersc)}_{\text{readout}}
        \underbrace{p(\photons|\z{},\parameterse)}_{\text{shot}}
    \text{.}
    \label{eq:method:marginalized_intensity}
  \end{equation}

\paragraph{Readout Noise}

The readout noise from the detector is often assumed to be negligible (\ie when
using an EMCCD camera).
  %
  However, when using an sCMOS camera, it's contribution is significant and 
  must be accounted for~\citep{huang_video-rate_2013}.
  %
  To accommodate both systems, here we include the readout noise in our model.
  %
  Given \photons photons, the readout intensity of the camera is normally
  distributed~\citep{huang_video-rate_2013}
  %
  \begin{equation}
    p(\x{}|\photons,\parametersc) = \mathcal{N}[\photons\camgain + \camoffset, \camvar](\x{})
    \text{,}
  \end{equation}
  %
  where $\parametersc = (\camgain, \camoffset, \camvar)$ are the camera's gain,
  offset, and variance, respectively.

  In the following, it will be beneficial to express the readout noise as a
  zero mean normal distribution that is independent of the number of photons
  detected. To that end, we transform our measurements \x{} into photon space
  by accounting for the camera gain and offset:
  %
  \begin{equation}
    \xp{} = \frac{\x{} - \camoffset}{\camgain}
    \;\;\;\;
    \x{} = \xp{}\camgain + \camoffset
    \text{.}
  \end{equation}
  %
  We can now express our readout noise distribution in terms of the transformed
  measurements \xp{}, which we further shift by $-\photons$ to obtain a
  zero-mean distribution:
  %
  \begin{align}
    p(\xp{}|\photons,\parametersc)
      &= \mathcal{N}[\photons, \frac{\camvar}{\camgain^2}](\xp{})  \\
      &= \mathcal{N}[0, \frac{\camvar}{\camgain^2}](\xp{} - \photons)
      \label{eq:method:transformed_readout_noise}
    \text{.}
  \end{align}

\paragraph{Shot Noise}

Due to shot noise, the number of photons detected over a time interval
$\deltat$ is Poisson distributed~\cite{mehta_poisson_2016}
(\figref{fig:method:overview}c).
  %
  Our model accounts for two sources of emitted photons: first, the \z{} active
  emitters produce photons at a rate $\z{}\re$, and second, out of plane
  emitters produce a relatively constant amount of background photons \rb.
  %
  Combined, these sources produce the expected number of photons
  $\lambda=(\z{}\re + \rb)\deltat$ per frame.
  %
  \begin{equation}
    p(\photons|\z{},\parameterse)
      = \poisson[\underbrace{(\z{}\re + \rb)\deltat}_{\lambda}](\photons)
    \text{.}
  \end{equation}
  %
  For large values of $\lambda$ the Poisson distribution approaches a normal
  distribution with both mean and variance of $\lambda$ and therefore we
  approximate our shot noise distribution as:
  %
  \begin{equation}
    p(\photons|\z{},\parameterse)
      \approx \mathcal{N}[\lambda, \lambda](\photons)
    \text{.}
    \label{eq:method:normal_approx_shot_noise}
  \end{equation}

\paragraph{Combined Intensity Model}

Taking together the measurement transform
\eqref{eq:method:transformed_readout_noise} and approximation ~\eqref{eq:method:normal_approx_shot_noise}, the
intensity distribution \eqref{eq:method:marginalized_intensity} can now be
rewritten as
%
  \begin{equation}
    p(\xp{}|\z{},\parametersc, \parameterse)
      = \sum_\photons
        \mathcal{N}[0, \frac{\camvar}{\camgain^2}](\xp{} - \photons)
        \mathcal{N}[\lambda, \lambda](\photons)
    \text{.}
  \end{equation}
  %
  Similar to~\cite{huang_video-rate_2013}, we note that this expression
  resembles a convolution, \ie, the sum of two independent random variables
  (the photon count \photons and a zero-mean, photon-independent camera readout
  noise, see~\eqref{eq:method:transformed_readout_noise}). Since the two distributions are normal, we can rewrite
  the above as a single normal distribution with summed means and variances:
  %
  \begin{equation}
    p(\xp{}|\z{},\parametersc, \parameterse)
      = \mathcal{N}[\lambda, \lambda + \frac{\camvar}{\camgain^2}](\xp{})
    \text{.}
    \label{eq:method:combined_intensity}
  \end{equation}

\subsubsection{Transition Model}
Next, to model the step-like temporal fluctuations in intensity, observed in the trace \trace, 
  a distribution is needed that describes the change in the number of active emitters \z{} over time. 
  %
  To do this, we assume that the process is Markovian and the number of active emitters \z{t} 
  at time $t$ is only dependent on the number of active emitters at the previous time point \z{t-1}.
  %
  On the individual emitter level, we define \pon as the probability of an emitter inactive at time $t-1$ becoming active at time $t$. 
  Conversely,  we define \poff as the probability of an emitter active at $t-1$ becoming inactive at time $t$ (\figref{fig:method:overview}b).
  %
  Finally, assuming that all emitters share the same \pon and \poff, and that both remain constant over time, 
  the transition distribution can be written as:
  % 
  \begin{align}
    \label{eq:method:transition}
    p(z_{t} = z | z_{t-1}, \theta_{T}, n) &=\\
    \sum_{a = 0}^{z_{t-1}}
      {a \choose z_{t-1}}
      &\poff
      {z - z_{t-1} + a \choose \n - z_{t-1}}
      \pon
      \text{,} \notag\
  \end{align}
  %
  Note that this distribution depends on the total possible number of emitters $n$.

\subsubsection{Inference}

\eqref{eq:method:HMM} describes the likelihood of observing \trace given seven fittable parameters and \n.
  %
  However, because the complexity of this expression is dependant on \n, the likelihoods for each \n are not directly comparable to one another.
  Rather, the model evidence, also known as the marginal likelihood, must be used to compare different values of \n and build the posterior. 

  \begin{equation*}
    p(\trace | n) = \int p(\trace | \theta, n) p(\theta | n) d\theta
  \end{equation*}

  This integral over all possible parameters \parameters = (\parametersc, \parameterse, \parameterst) can be approximated using the 
  Laplace approximation also called an Occam factor \cite{bishop_pattern_2006}
  %
  \begin{equation}
    \begin{aligned}
      \ln p(\trace | n) \approx \ln p(\trace | \parameters_{MAP}, \n) + \ln p(\parameters_{MAP}) \\
      + \frac{M}{2} \ln(2\pi) - \frac{1}{2} \ln |A|
      \label{eq:method:evidence_with_m}
    \end{aligned}
  \end{equation}

  \begin{equation*}
    A = -\nabla \nabla \ln p(\parameters_{MAP} | \trace)
  \end{equation*}

  $M$ is the dimensionality of \parameters, which in \ours is constant for all \n (only the size of the transition matrix changes).
  %
  Therefore this term becomes a constant and can be dropped from \eqref{eq:method:evidence_with_m}, resulting in:
  \begin{equation}
    \ln p(\trace | \n) \approx \ln p(\trace | \parameters_{MAP}, \n) + \ln p(\parameters_{MAP}) - \frac{1}{2} \ln |A|
    \label{eq:method:evidence}
  \end{equation}
  %
  Therefore, to estimate the posterior distribution over \n we first need to 
  find the maximum a posteriori (MAP) parameters for each value of \n. 

  % blinx if fully differentiable
  \ours is implemented fully differentiably in JAX , so $p(\trace | \parameters_{MAP}, \n)$ can be efficiently 
  fit through gradient ascent.
  %
  Finally, the molecular count can be obtained:
  %
  \begin{equation}
      \estimatedn =
      \text{arg}\max_{n}(
      \max_\parameters
      p(\trace|\n,\parameters))
    \text{.}
    \label{eq:method:optimization}
  \end{equation}

\subsection{Experimental}
\subsubsection{DNA Origami}
DNA origami with 20 nm spaced docking strands, were designed with the Picasso-design module \cite{schnitzbauer_2017}, 
  and a list of all single-strand DNA used as well as a detailed folding procedure can be found in \cite{schnitzbauer_2017}.
  %
  A repetitive 11 nt docker sequence (CTCCTCCTCCT) was conjugated to the 5' end of select staple strands to form the grid.
  %
  Such repetitive sequences have been shown to increase \pon, while being short enough to prevent double binding events \cite{civitci_2020}.
  %
  DNA origamis samples were prepared for imaging following the procedure described in \cite{schnitzbauer_2017}. 
  %
  Briefly, a chamber (ibidi $\mu$-Slide 8-well glass bottom) was pacified with BSA, coated in streptavidin, and biotinylated origamis conjugated. 

\subsubsection{DNA-PAINT}
DNA-PAINT imaging was performed following the standard procedure detailed in \cite{schnitzbauer_2017}. 
  %
  Imaging solution contained buffer B (5 mM Tris-HCl, 10 mM MgCl$_2$ 1 mM EDTA, pH 8) and an oxygen scavenging system consisting of PCA, PCD, and Trolox.
  %
  For super-resolution experiments, 10nM of a 7 nt imager (GAGGAGG) was used, while for \ours counting analysis 
  20 nM of an 8 nt imager (GAGGAGGA) was used.
  %
  Both imagers were conjugated to at the 3' end to a Cy3B fluorophore, and a 200 ms exposure time was used for all experiments.
  %
  Images were post-processed in the Picasso-localize module to detect spots and correct drift over the time course. 
  %
  Super-resolution images were visualized in Picasso-render.

\subsubsection{Microscopy}
% Microscopy system
TIRF imaging was performed on a Zeiss Elyra 7 microscope, equipped with a pco.edge 4.2 sCMOS camera (pixel size 6.5 $\mu$m)
  %
  An $\alpha$ Plan-Apochromat 63x/1.46 TIRF oil immersion objective was used.
  % Chiller system
  For temperature control, an okolab H101-Cryo-BL system was used. Temperature readings were taken using a thermocouple from a water filled well neighboring 
  that of the sample in the 8 well chamber slide 
  % 
  It was found that this temperature control system was not compatible with super-resolution experiments, 
  due to vibrations caused by the pump, and transferred to the objective through the cooling jacket.
  % 
  Therefore for super-resolution experiments, the temperature control system was turned off, 
  and the sample temperature allowed to increase to room temp (25 C) before imaging.
  %
  % Further complications of DNA-PAINT at cool temperatures are discussed in the SI


